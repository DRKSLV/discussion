{"version":3,"file":"static/webpack/static\\development\\pages\\index.js.4dba176fc00f2bb6fcd2.hot-update.js","sources":["webpack:///./hooks/identity.js"],"sourcesContent":["import { createContext, useContext, useState, useEffect } from \"react\";\r\nimport Axios from \"axios\";\r\n\r\nconst Identity = createContext([{active: null, users:[]}, undefined]);\r\n\r\n\r\n\r\n\r\nexport class IdentityProvider extends React.Component{\r\n    constructor(props) {\r\n        super(props);\r\n\r\n        this.state= {\r\n            id: {active: null, users: []},\r\n            axios: undefined\r\n        };\r\n\r\n        this.beforeMount();\r\n    }\r\n\r\n    request = (req) => {\r\n        const ide = this.state.id;\r\n        if(Number.isInteger(ide.active) && ide.users && ide.users[ide.active]) {\r\n            console.log(\"token supplied\");\r\n            req.headers.Authorization = `Bearer ${ide.users[ide.active].accessToken}`;\r\n        }\r\n        return req;\r\n    }\r\n\r\n    response = (res) => {\r\n        if(res.status === 401) {\r\n            var no = res.headers[\"Www-Authenticate\"].split(\",\");\r\n            ///...\r\n\r\n            ///removeUser(id.users[id.active].idString);\r\n        } \r\n        return res;\r\n    }\r\n\r\n    reject = (error) => {\r\n        // Do something with request error\r\n        return Promise.reject(error);\r\n    }\r\n\r\n    addUser = (idString, username, accessToken) => {\r\n        this.setState ((prev) => {\r\n            var newO = {...prev.id};\r\n\r\n            var index = newO.users.findIndex((val) => val.idString = idString);\r\n            if(index===-1)\r\n                newO.users = [...newO.users, {idString, username, accessToken}];\r\n            \r\n            return {id: newO};\r\n        });\r\n    }\r\n\r\n    removeUser= (idString) => {\r\n        this.setState((prev) => {\r\n            var newO = {...prev.id};\r\n\r\n            var index = newO.users.findIndex((val) => val.idString = idString);\r\n            if(index>-1)\r\n                newO.users = newO.users.slice(index, index+1);\r\n            \r\n            return {id: newO};\r\n        });\r\n    }\r\n\r\n    setActive = (idx) => {\r\n        this.setState((prev) => {\r\n            var newO = {...prev.id};\r\n\r\n            if(idx > -1 && idx < prev.id.users.length || idx === null) {\r\n                newO.active = idx;    \r\n            } \r\n            return {id: newO};\r\n        });\r\n    }\r\n\r\n    persist() {\r\n        console.log(\"persist\");\r\n        localStorage.setItem(\"active\", JSON.stringify(this.state.id.active));\r\n        localStorage.setItem(\"users\", JSON.stringify(this.state.id.users));\r\n    }\r\n\r\n    checkActive() {\r\n        if(this.state.id.active !== null) {\r\n            this.state.axios.get(\"/protected\")\r\n            .then((val) => {\r\n                console.log(\"✔ Account ok: \",val);\r\n            }, (reason)=>{\r\n                console.log(\"❌ Account bad: \", reason);\r\n\r\n                if(reason.response && reason.response.headers[\"www-authenticate\"]) {\r\n                    //authenticate header\r\n                    var auth = reason.response.headers[\"www-authenticate\"];\r\n                    console.log(auth);\r\n                    var tokens = auth.split(\",\").map(x => x.trim());\r\n\r\n                    var error= {};\r\n\r\n                    //parse header\r\n                    if(tokens[1] && tokens[1].startsWith('error=\"')) {\r\n                        error.err = tokens[1].substring(7, tokens[1].length-1);\r\n                    }\r\n                    if(tokens[2] && tokens[2].startsWith('error_description=\"')) {\r\n                        error.desc = tokens[2].substring(19, tokens[2].length-1);    \r\n                    }\r\n\r\n                    //decide what to do\r\n                    switch(error.err) {\r\n                        case \"UnsupportedAuthError\":\r\n                            throw reason;\r\n                        \r\n                        case \"TokenClaimError\":\r\n                            if(error.desc === \"insufficient claims.\")\r\n                                error.icon = \"bolt\"\r\n                            else if(error.desc === \"invalid claims.\")\r\n                                error.icon = \"death\"\r\n                            \r\n                        case \"TokenExpiredError\":\r\n                            error.icon = \"time\";\r\n\r\n                        case \"NotBeforeError\":\r\n                            error.icon = \"time\"\r\n\r\n                        case \"JsonWebTokenError\":\r\n                            error.icon = \"bolt\"\r\n                    }\r\n\r\n                    console.log(error);\r\n                    this.setState((prev) => {\r\n                        return {id:{...prev.id, active: null, }\r\n                    }});\r\n                } \r\n\r\n                //tf happened\r\n                this.setState((prev) => {return {id:{...prev.id, active: null}}});\r\n                \r\n            })\r\n        }\r\n    }\r\n\r\n    beforeMount() {\r\n        if(typeof window === 'undefined') {\r\n            return;\r\n        }\r\n        console.log(\"before\");\r\n\r\n        //get initial data\r\n        var active,users;\r\n\r\n        try {\r\n            active = JSON.parse(localStorage.getItem(\"active\") || \"null\");  \r\n        } catch (error) {\r\n            active= this.state.id.active;\r\n        }\r\n        try {\r\n            users = JSON.parse(localStorage.getItem(\"users\") || \"[]\");\r\n        } catch (error) {\r\n            users= this.state.id.users;\r\n        }\r\n        \r\n\r\n        const instance = Axios.create({\r\n            baseURL: \"https://drkslv.herokuapp.com\"\r\n        });\r\n\r\n        instance.interceptors.request.use(this.request, this.reject);\r\n        instance.interceptors.response.use(this.response, this.reject);\r\n\r\n        //pass context down\r\n         \r\n        this.state.id= {active, users, addUser: this.addUser, removeUser: this.removeUser, setActive: this.setActive};\r\n        this.state.axios = instance;\r\n\r\n        //this.setState(prev=> {return {id: {active, users, addUser: this.addUser, removeUser: this.removeUser, setActive: this.setActive}, axios: instance}});\r\n    }\r\n\r\n    componentDidMount() {\r\n        this.checkActive();\r\n    }\r\n\r\n\r\n    render() {\r\n        if(typeof window !== 'undefined') {\r\n            this.persist();\r\n        }\r\n        return <Identity.Provider value={[this.state.id, this.state.axios]}>\r\n            {this.props.children}\r\n        </Identity.Provider>;\r\n    }\r\n        \r\n}\r\n    \r\n\r\nexport const useIdentity = () => {\r\n    return useContext(Identity);\r\n}\r\n\r\n// [{\"username\": \"test-_-\", \"idString\": \"gamer\", \"accessToken\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiI2MGMzYjRlMC04YjI5LTExZWEtODI5MS0xM2JmNDBkZmVmYWQiLCJpYXQiOjE1OTEzOTI0MTksImV4cCI6MTU5MTk5NzIxOSwiYXVkIjoiVXNlciIsImlzcyI6IkRSS1NMViJ9.dcnyAkv1Z3qzPdBpo_0s4-YP642amNVOGFCwMItvsoo\"}, {\"username\": \"gamer\", \"idString\": \"gamer\", \"accessToken\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiI0ZWU3NjkxMC04YjI5LTExZWEtODI5MS0xM2JmNDBkZmVmYWQiLCJpYXQiOjE1OTEzOTI0NTIsImV4cCI6MTU5MTk5NzI1MiwiYXVkIjoiVXNlciIsImlzcyI6IkRSS1NMViJ9.0P6NWE5rV3V-RBdkFRcBmWgydpMH07yzP2Uij86PReQ\"}]\r\n//\r\n//"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AAKA;AAAA;AACA;AADA;AACA;AAAA;AAAA;AACA;AADA;AACA;AAAA;AACA;AAFA;AAYA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAnBA;AAqBA;AACA;AAGA;AACA;AACA;AAAA;AACA;AACA;AA7BA;AA+BA;AACA;AACA;AACA;AAlCA;AAoCA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AA9CA;AAgDA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAGA;AAAA;AAAA;AACA;AACA;AACA;AA1DA;AA4DA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAlEA;AACA;AAAA;AAAA;AAAA;AACA;AAFA;AACA;AAIA;AACA;AATA;AASA;AACA;AAXA;AAAA;AAAA;AAwEA;AACA;AACA;AACA;AA3EA;AAAA;AAAA;AA6EA;AACA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAjBA;AACA;AAmBA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AArIA;AAAA;AAAA;AAwIA,mBAEA;AACA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AADA;AAIA;AACA;AACA;AAGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAGA;AAzKA;AAAA;AAAA;AA4KA;AACA;AA7KA;AAAA;AAAA;AAiLA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAvLA;AACA;AADA;AAAA;AA4LA;AACA;AACA;AAGA;AACA;;;;A","sourceRoot":""}